<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Merge Sort Visualization</title>
<style>
  :root{
    --bg:#0f1724;
    --panel:#0b1220;
    --accent:#64d2ff;
    --accent-2:#8b5cf6;
    --muted:#94a3b8;
    --good:#22c55e;
    --danger:#ef4444;
    --bar-bg: linear-gradient(180deg,#60a5fa11,#3b82f611);
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#071022);color:#e6eef6}
  .app{
    display:grid;
    grid-template-columns: 360px 1fr;
    gap:20px;
    padding:22px;
    min-height:100vh;
    box-sizing:border-box;
  }

  /* Left panel controls */
  .panel{
    background:linear-gradient(180deg,var(--panel),rgba(255,255,255,0.02));
    border-radius:12px;
    padding:18px;
    box-shadow:0 6px 24px rgba(2,6,23,0.6);
  }
  h2{margin:0 0 10px 0;color:white;font-size:18px}
  .controls {display:flex;flex-direction:column;gap:12px}
  .row{display:flex;gap:8px;align-items:center}
  button{
    background:linear-gradient(180deg,var(--accent),var(--accent-2));
    color:#022;
    border:none;padding:8px 12px;border-radius:8px;font-weight:600;cursor:pointer;
    box-shadow:0 6px 18px rgba(20,25,40,0.5);
  }
  button.secondary{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--muted);box-shadow:none}
  input[type=range]{width:100%}
  label{font-size:12px;color:var(--muted)}

  /* Visualization area */
  .vis{
    display:flex;flex-direction:column;gap:12px;
  }
  .canvas{
    background:linear-gradient(180deg,#051024,#04101a);
    border-radius:12px;padding:12px;flex:1;display:flex;align-items:end;overflow:hidden;
    min-height:320px;position:relative;
  }
  .bars{display:flex;align-items:end;height:100%;width:100%;gap:4px;padding:8px;box-sizing:border-box}
  .bar{
    flex:1 1 auto; border-radius:4px 4px 2px 2px; background:var(--bar-bg);
    display:flex;align-items:flex-end;justify-content:center;position:relative;transition:all 250ms ease;
    box-shadow:0 2px 6px rgba(18,32,60,0.4) inset;
  }
  .bar .val{font-size:11px;color:rgba(255,255,255,0.9);padding:6px 4px 6px 4px;transform:translateY(-6px)}
  .bar.highlight-compare{box-shadow:0 0 0 3px rgba(100,210,255,0.08);transform:translateY(-6px)}
  .bar.highlight-left{outline:3px solid rgba(139,92,246,0.18)}
  .bar.highlight-right{outline:3px solid rgba(100,210,255,0.12)}
  .bar.merged{background:linear-gradient(180deg,#16a34a22,#16a34a11);transform:translateY(-8px)}
  .bar.moving{opacity:0.95;transform:translateY(-18px) scale(1.02)}

  /* Pseudocode */
  .codebox{
    background:#07152a;border-radius:8px;padding:12px;color:var(--muted);font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", monospace;font-size:13px;
    max-height:220px;overflow:auto;
  }
  .codebox pre{margin:0;white-space:pre-wrap}
  .code-line{padding:4px 6px;border-radius:6px}
  .code-line.active{background:linear-gradient(90deg, rgba(100,210,255,0.06), rgba(139,92,246,0.02));color:white}
  .small{font-size:12px;color:var(--muted)}

  /* footer / info */
  .meta{display:flex;gap:12px;align-items:center;flex-wrap:wrap}
  .chip{background:rgba(255,255,255,0.03);padding:6px 10px;border-radius:999px;font-size:13px;color:var(--muted)}
  .legend{display:flex;gap:8px;align-items:center}
  .legend .dot{width:12px;height:12px;border-radius:3px;background:var(--accent);display:inline-block;margin-right:6px}

  @media (max-width:920px){
    .app{grid-template-columns:1fr; padding:12px}
    .panel{order:2}
  }
</style>
</head>
<body>
<div class="app">
  <div class="panel">
    <h2>Merge Sort — Visualizer</h2>
    <div class="controls">
      <div class="row" style="gap:8px;">
        <button id="btn-generate">Generate</button>
        <button id="btn-start">Start</button>
        <button id="btn-pause" class="secondary">Pause</button>
        <button id="btn-step" class="secondary">Step</button>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Array size: <span id="size-val" class="small">20</span></label>
          <input id="size" type="range" min="6" max="120" value="20">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Speed (ms delay): <span id="speed-val" class="small">250</span></label>
          <input id="speed" type="range" min="20" max="1200" value="250">
        </div>
      </div>

      <div class="row">
        <div style="flex:1">
          <label>Array distribution</label>
          <select id="distribution" style="width:100%;padding:8px;border-radius:8px;border:none;background:rgba(255,255,255,0.02);color:var(--muted)">
            <option value="random">Random</option>
            <option value="almost-sorted">Almost sorted</option>
            <option value="reversed">Reversed</option>
            <option value="few-unique">Few unique</option>
          </select>
        </div>
      </div>

      <div class="row small" style="margin-top:8px;flex-direction:column;gap:6px">
        <div><strong>Tips:</strong> Use <em>Step</em> to advance one visualization action at a time. Pause to inspect frames.</div>
      </div>

      <div style="margin-top:10px">
        <div class="chip">Stable sort — preserves equal values' order</div>
      </div>

      <div style="margin-top:12px">
        <div class="small">Legend</div>
        <div class="legend" style="margin-top:6px">
          <div style="display:flex;align-items:center;gap:8px">
            <span class="dot" style="background:linear-gradient(180deg,#64d2ff,#8b5cf6)"></span> active / comparing
          </div>
          <div style="display:flex;align-items:center;gap:8px;margin-left:8px">
            <span class="dot" style="background:linear-gradient(180deg,#22c55e,#16a34a)"></span> merged
          </div>
        </div>
      </div>

      <div style="margin-top:14px">
        <div class="small">Algorithm pseudocode</div>
        <div class="codebox" id="pseudocode">
<pre id="code">
1  function mergeSort(A, l, r)
2      if l >= r
3          return
4      mid = floor((l + r) / 2)
5      mergeSort(A, l, mid)
6      mergeSort(A, mid+1, r)
7      merge(A, l, mid, r)

8  function merge(A, l, mid, r)
9      i = l, j = mid+1
10     temp = []
11     while i <= mid and j <= r
12         if A[i] <= A[j]
13             temp.push(A[i]); i++
14         else
15             temp.push(A[j]); j++
16     while i <= mid
17         temp.push(A[i]); i++
18     while j <= r
19         temp.push(A[j]); j++
20     copy temp back into A[l..r]
</pre>
        </div>
      </div>
    </div>
  </div>

  <div class="vis">
    <div style="display:flex;justify-content:space-between;align-items:center">
      <div class="meta">
        <div class="chip">Elements: <span id="el-count">20</span></div>
        <div class="chip">Operations: <span id="ops-count">0</span></div>
      </div>
      <div class="small">By: Merge-sort visualizer — have fun!</div>
    </div>

    <div class="canvas" id="canvas">
      <div class="bars" id="bars"></div>
    </div>

    <div style="display:flex;gap:12px">
      <div style="flex:1">
        <div class="small">Call stack / actions</div>
        <div id="log" class="codebox" style="height:120px;overflow:auto"></div>
      </div>
      <div style="width:320px">
        <div class="small">Current highlighted pseudocode line</div>
        <div class="codebox" id="active-code" style="height:120px;overflow:auto"></div>
      </div>
    </div>
  </div>
</div>

<script>
(function(){
  // ---------- Utilities ----------
  const $ = (id) => document.getElementById(id);
  let array = [];
  let barsEl = $('bars');
  let ops = 0;
  let paused = false;
  let stepMode = false;
  let stepResolve = null;
  let running = false;

  // sleep that respects pause & step
  function sleep(ms){
    return new Promise(resolve=>{
      const start = Date.now();
      (function tick(){
        if (!running) return resolve(); // if stopped externally
        if (paused) {
          setTimeout(tick, 30);
          return;
        }
        if (stepMode) {
          // wait until user presses Step (resolves stepResolve)
          if (stepResolve) {
            const r = stepResolve;
            stepResolve = null;
            r();
            resolve();
            return;
          } else {
            setTimeout(tick, 30);
            return;
          }
        }
        const elapsed = Date.now() - start;
        if (elapsed >= ms) resolve();
        else setTimeout(tick, Math.min(50, ms-elapsed));
      })();
    });
  }

  function randInt(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }

  // ---------- DOM helpers ----------
  function renderArray(){
    barsEl.innerHTML = '';
    const maxV = Math.max(...array, 1);
    array.forEach((v, i)=>{
      const bar = document.createElement('div');
      bar.className = 'bar';
      bar.style.height = (v / maxV * 88) + '%';
      bar.dataset.index = i;
      const val = document.createElement('div');
      val.className = 'val';
      val.textContent = v;
      bar.appendChild(val);
      barsEl.appendChild(bar);
    });
    $('el-count').textContent = array.length;
  }

  function highlightRange(l,r,cls){
    for(let i=l;i<=r;i++){
      const b = barsEl.children[i];
      if (b) b.classList.add(cls);
    }
  }
  function clearHighlights(){
    Array.from(barsEl.children).forEach(b=>{
      b.classList.remove('highlight-left','highlight-right','highlight-compare','merged','moving');
    });
  }

  function swapHeights(i, h){ // set bar i with height h (value)
    const b = barsEl.children[i];
    if (!b) return;
    b.style.height = (h + '%'); // expects fraction percentage already provided for animation convenience
  }

  function setBarValue(i, value){
    const b = barsEl.children[i];
    if (!b) return;
    b.querySelector('.val').textContent = value;
    // adjust height proportional to current max
    const maxV = Math.max(...array, 1);
    b.style.height = (value / maxV * 88) + '%';
  }

  function log(msg){
    const el = $('log');
    const p = document.createElement('div');
    p.textContent = msg;
    p.style.padding = '4px 6px';
    el.appendChild(p);
    el.scrollTop = el.scrollHeight;
  }

  // Code highlighting
  const codeLines = Array.from(document.querySelectorAll('#code')[0].textContent.split('\n')).map((ln,i)=>{
    return {text:ln, el:null};
  });
  const codeBox = $('active-code');
  function renderCode(){
    codeBox.innerHTML='';
    codeLines.forEach((ln,i)=>{
      const div = document.createElement('div');
      div.className = 'code-line';
      div.dataset.line = i+1;
      div.textContent = ln.text;
      codeBox.appendChild(div);
      ln.el = div;
    });
  }
  function setActiveLine(n){
    codeLines.forEach((ln,idx)=>{
      if (ln.el) ln.el.classList.toggle('active', idx+1 === n);
    });
    // also visually scroll pseudocode
    if (codeLines[n-1] && codeLines[n-1].el) {
      codeLines[n-1].el.scrollIntoView({behavior:'smooth',block:'nearest'});
    }
  }

  // ---------- Merge Sort algorithm with animation ----------
  async function mergeSortVisual(A, l, r, speed){
    setActiveLine(1); // function start
    if (l >= r) {
      setActiveLine(2);
      await sleep(speed * 0.6);
      return;
    }
    setActiveLine(4);
    await sleep(speed * 0.5);

    const mid = Math.floor((l + r) / 2);
    log(`Recurse left: [${l}..${mid}]`);
    setActiveLine(5);
    highlightRange(l, mid, 'highlight-left');
    await mergeSortVisual(A, l, mid, speed);
    clearHighlights();

    log(`Recurse right: [${mid+1}..${r}]`);
    setActiveLine(6);
    highlightRange(mid+1, r, 'highlight-right');
    await mergeSortVisual(A, mid+1, r, speed);
    clearHighlights();

    setActiveLine(7);
    await sleep(speed * 0.4);
    await mergeVisual(A, l, mid, r, speed);
  }

  async function mergeVisual(A, l, mid, r, speed){
    setActiveLine(8);
    highlightRange(l, r, 'highlight-compare');
    await sleep(speed * 0.6);

    let i = l, j = mid+1;
    const temp = [];
    setActiveLine(11);
    while (i <= mid && j <= r){
      setActiveLine(12);
      // highlight compare
      const bi = barsEl.children[i];
      const bj = barsEl.children[j];
      if (bi) bi.classList.add('highlight-compare');
      if (bj) bj.classList.add('highlight-compare');
      await sleep(Math.max(40, speed * 0.45));
      ops++; $('ops-count').textContent = ops;

      if (A[i] <= A[j]){
        setActiveLine(13);
        temp.push(A[i]);
        log(`Compare: A[${i}] <= A[${j}] → push ${A[i]}`);
        // animate 'taking' bar i
        if (bi){ bi.classList.add('moving'); }
        await sleep(Math.max(30, speed * 0.3));
        if (bi){ bi.classList.remove('moving'); }
        i++;
      } else {
        setActiveLine(15);
        temp.push(A[j]);
        log(`Compare: A[${i}] > A[${j}] → push ${A[j]}`);
        if (bj){ bj.classList.add('moving'); }
        await sleep(Math.max(30, speed * 0.3));
        if (bj){ bj.classList.remove('moving'); }
        j++;
      }
      // clear compare highlight
      if (bi) bi.classList.remove('highlight-compare');
      if (bj) bj.classList.remove('highlight-compare');
      await sleep(Math.max(30, speed * 0.15));
    }

    setActiveLine(16);
    while (i <= mid){
      setActiveLine(17);
      temp.push(A[i]);
      log(`Remaining left: push ${A[i]}`);
      const bi = barsEl.children[i];
      if (bi){ bi.classList.add('moving'); }
      await sleep(Math.max(20, speed * 0.25));
      if (bi){ bi.classList.remove('moving'); }
      i++;
      ops++; $('ops-count').textContent = ops;
    }

    setActiveLine(18);
    while (j <= r){
      setActiveLine(19);
      temp.push(A[j]);
      log(`Remaining right: push ${A[j]}`);
      const bj = barsEl.children[j];
      if (bj){ bj.classList.add('moving'); }
      await sleep(Math.max(20, speed * 0.25));
      if (bj){ bj.classList.remove('moving'); }
      j++;
      ops++; $('ops-count').textContent = ops;
    }

    setActiveLine(20);
    // Copy temp back into A[l..r] with animated updates
    for (let k = 0; k < temp.length; k++){
      A[l + k] = temp[k];
      setBarValue(l + k, temp[k]);
      const b = barsEl.children[l+k];
      if (b) b.classList.add('merged');
      await sleep(Math.max(20, speed * 0.25));
      ops++; $('ops-count').textContent = ops;
    }
    await sleep(Math.max(30, speed * 0.2));
    clearHighlights();
  }

  // ---------- Controls ----------
  function generate(distribution='random', size=20){
    array = [];
    if (distribution === 'random'){
      for(let i=0;i<size;i++) array.push(randInt(5, 100));
    } else if (distribution === 'reversed'){
      for(let i=size;i>0;i--) array.push(Math.floor(i/size*100)+1);
    } else if (distribution === 'almost-sorted'){
      for(let i=0;i<size;i++) array.push(Math.floor(i/size*100)+1);
      // shuffle a few
      for(let k=0;k<Math.max(1,Math.floor(size*0.08));k++){
        const a=randInt(0,size-1), b=randInt(0,size-1);
        [array[a],array[b]] = [array[b],array[a]];
      }
    } else if (distribution === 'few-unique'){
      const uniq = Math.max(2, Math.floor(size*0.08));
      for(let i=0;i<size;i++) array.push( Math.ceil((i%uniq)/uniq*100)+randInt(0,6) );
    }
    ops = 0; $('ops-count').textContent = ops;
    renderArray();
    $('size-val').textContent = size;
    $('el-count').textContent = size;
    $('log').innerHTML = '';
    renderCode();
    setActiveLine(0);
  }

  async function start(){
    if (running) return;
    running = true;
    paused = false;
    stepMode = false;
    $('btn-start').textContent = 'Running...';
    $('btn-start').disabled = true;
    $('btn-pause').textContent = 'Pause';
    const speed = parseInt($('speed').value,10);
    try{
      await mergeSortVisual(array, 0, array.length-1, speed);
      log('Sorting complete.');
    } catch(e){
      console.error(e);
      log('Execution stopped unexpectedly.');
    } finally {
      running = false;
      $('btn-start').textContent = 'Start';
      $('btn-start').disabled = false;
      clearHighlights();
      setActiveLine(0);
    }
  }

  function stop(){
    running = false;
  }

  function togglePause(){
    if (!running) return;
    paused = !paused;
    $('btn-pause').textContent = paused ? 'Resume' : 'Pause';
    if (!paused) {
      // if unpausing while stepMode had a pending step promise, resolve one to continue loop
      if (stepResolve) { stepResolve(); stepResolve = null; }
    }
  }

  function enableStep(){
    if (!running) {
      // start running in step mode
      running = true;
      stepMode = true;
      paused = false;
      $('btn-start').textContent = 'Running (step)';
      $('btn-start').disabled = true;
      $('btn-pause').textContent = 'Pause';
      const speed = parseInt($('speed').value,10);
      mergeSortVisual(array, 0, array.length-1, speed).then(()=>{
        running=false;
        $('btn-start').textContent='Start';
        $('btn-start').disabled=false;
        stepMode=false;
      });
    } else {
      // toggle step mode on while running
      stepMode = !stepMode;
    }
  }

  function doStep(){
    if (!running && !stepMode) {
      enableStep();
      return;
    }
    if (!stepMode) {
      stepMode = true;
      paused = false;
    }
    if (stepResolve) {
      // there may already be a pending step running; ignore
      return;
    }
    stepResolve = () => { /* resolved by code */ };
    // create a small promise resolution that the algorithm can use
    const prom = new Promise(res=>{ const old = stepResolve; stepResolve = ()=>{ res(); old && old(); }; });
    // resolve immediately to let the algorithm continue one step (algorithm waits on stepResolve)
    if (stepResolve) { stepResolve(); stepResolve = null; }
  }

  // ---------- Event wiring ----------
  $('btn-generate').addEventListener('click', ()=>{
    const size = parseInt($('size').value,10);
    const dist = $('distribution').value;
    generate(dist, size);
  });

  $('size').addEventListener('input', (e)=>{
    $('size-val').textContent = e.target.value;
  });

  $('speed').addEventListener('input', (e)=>{
    $('speed-val').textContent = e.target.value;
  });

  $('btn-start').addEventListener('click', start);
  $('btn-pause').addEventListener('click', togglePause);
  $('btn-step').addEventListener('click', doStep);

  // initialize
  generate('random', 20);

  // allow clicking bars to highlight index
  barsEl.addEventListener('click', (ev)=>{
    const b = ev.target.closest('.bar');
    if (!b) return;
    const idx = Number(b.dataset.index);
    log(`Clicked index ${idx} value ${array[idx]}`);
    // simple flash
    b.classList.add('highlight-compare');
    setTimeout(()=>b.classList.remove('highlight-compare'), 350);
  });

  // a small safety: stop running if user navigates away
  window.addEventListener('beforeunload', ()=>{ stop(); });

})();
</script>

</body>
</html>
